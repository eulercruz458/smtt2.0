<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Perícia - Mental, Auditivo e Visual</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script>
    const usuarioLogado = "usuario"; // Mude para "solange" para acesso administrativo
    const vagasPreenchidas = {}; // Armazena as vagas preenchidas em tempo real

    // Recupera agendamentos salvos no localStorage ao carregar
    function carregarVagasPreenchidas() {
      const salvos = JSON.parse(localStorage.getItem("vagasPreenchidas"));
      if (salvos) Object.assign(vagasPreenchidas, salvos);
    }

    // Atualiza a exibição visual das vagas preenchidas
    function atualizarExibicaoVagas() {
      for (const vagaId in vagasPreenchidas) {
        const botao = document.getElementById(`btn-${vagaId}`);
        if (botao) {
          botao.classList.remove("bg-green-500", "bg-blue-500", "hover:bg-green-600", "hover:bg-blue-600");
          botao.classList.add("bg-red-500", "hover:bg-red-600");
          botao.innerText = vagasPreenchidas[vagaId].nome;
        }
      }
    }

    // Salva as vagas preenchidas no localStorage
    function salvarVagasPreenchidas() {
      localStorage.setItem("vagasPreenchidas", JSON.stringify(vagasPreenchidas));
    }

    // Função principal para agendar
    function agendarPericia(nome, data, hora, turno, index) {
      const vagaId = `${turno}-${index}`;

      if (vagasPreenchidas[vagaId]) {
        alert(`Esta vaga já foi preenchida por ${vagasPreenchidas[vagaId].nome}.`);
        return;
      }

      if (!nome || nome === "Desconhecido") {
        alert("Nome não encontrado. Por favor, registre seu nome antes de agendar.");
        return;
      }

      const confirmacao = confirm(`Deseja agendar a perícia de ${nome} para o dia ${data} às ${hora}?`);
      if (confirmacao) {
        vagasPreenchidas[vagaId] = { nome, data, hora };
        salvarVagasPreenchidas();

        const botao = document.getElementById(`btn-${vagaId}`);
        botao.classList.remove("bg-green-500", "bg-blue-500", "hover:bg-green-600", "hover:bg-blue-600");
        botao.classList.add("bg-red-500", "hover:bg-red-600");
        botao.innerText = nome;

        // Salva informações completas no localStorage
    localStorage.setItem("periciaAgendada", "true");
    localStorage.setItem("nomeAgendamento", nome);
    localStorage.setItem("dataAgendamento", data);
    localStorage.setItem("horaAgendamento", hora);

    // Log de depuração
    console.log("Perícia agendada com sucesso:");
    console.log("Nome:", nome);
    console.log("Data:", data);
    console.log("Hora:", hora);
    console.log("Turno:", turno);
    console.log("Vaga ID:", vagaId);
        alert("Perícia agendada com sucesso!");
      }
    }

    // Permite que a Solange defina as datas
    function definirDatasAdmin() {
      if (usuarioLogado !== "solange") return;
      const novaData = prompt("Digite a data (formato: dd/mm):");
      if (novaData) {
        document.querySelectorAll(".data-vaga").forEach(el => el.innerText = novaData);
      }
    }

    // Gera os botões de vagas para um turno
    function gerarVagas(turnoIndex, hora, corClasse, turnoLabel) {
      let html = '';
      for (let i = 1; i <= 23; i++) {
        const vagaId = `${turnoLabel}-${i}`;
        html += `
          <button id="btn-${vagaId}"
            class="${corClasse} text-white py-1 rounded hover:opacity-90"
            onclick="agendarPericia(getNomeRequerente(), document.querySelectorAll('.data-vaga')[${turnoIndex}].innerText, '${hora}', '${turnoLabel}', ${i})">
            Vaga ${i}
          </button>
        `;
      }
      return html;
    }

    // Verifica se já foi feito um agendamento
    function verificarAgendamento() {
      return localStorage.getItem("periciaAgendada") === "true";
    }

    // Recupera o nome salvo
    function getNomeRequerente() {
      const nome = localStorage.getItem('nomeAgendamento');
      return nome ? nome : "Desconhecido";
    }

    // Salva o nome do requerente e redireciona
    function salvarNome() {
      const nomeRequerente = document.getElementById('nome').value;
      if (nomeRequerente.trim() !== '') {
        localStorage.setItem('nomeAgendamento', nomeRequerente);
        window.location.href = 'pericia-deficiencia-mental-auditiva-visual.html';
      } else {
        alert('Por favor, preencha o nome do requerente.');
      }
    }

    // Ao carregar a página
    window.onload = function () {
      carregarVagasPreenchidas();

      const nomeSalvo = localStorage.getItem('nomeAgendamento');
      if (nomeSalvo && document.getElementById('nomeRequerente')) {
        document.getElementById('nomeRequerente').value = nomeSalvo;
      }

      // Gera as vagas e atualiza com dados já agendados
      document.getElementById("vagas-manha").innerHTML = gerarVagas(0, "09:00", "bg-green-500 hover:bg-green-600", "manha");
      document.getElementById("vagas-tarde").innerHTML = gerarVagas(1, "12:00", "bg-blue-500 hover:bg-blue-600", "tarde");
      atualizarExibicaoVagas();
    };
  </script>
</head>

<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold text-center mb-6">Agendamento - Mental, Auditivo e Visual</h1>

    <!-- Botão para definir datas (apenas Solange) -->
    <div class="mb-4 text-center">
      <button 
        onclick="definirDatasAdmin()"
        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded"
      >
        Definir datas (somente Solange)
      </button>
    </div>

    <!-- Botão para voltar ao formulário -->
    <div class="mb-4 text-center">
      <button 
        onclick="verificarAgendamento() ? window.history.go(-2) : alert('Você precisa agendar a perícia antes de voltar ao formulário.')"
        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded"
      >
        Voltar para o Formulário
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Turno da Manhã -->
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Turno da Manhã - 09:00</h2>
        <p>Data: <span class="data-vaga">__/__</span></p>
        <div class="grid grid-cols-4 gap-2 mt-4" id="vagas-manha"></div>
      </div>

      <!-- Turno da Tarde -->
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Turno da Tarde - 12:00</h2>
        <p>Data: <span class="data-vaga">__/__</span></p>
        <div class="grid grid-cols-4 gap-2 mt-4" id="vagas-tarde"></div>
      </div>
    </div>
  </div>
</body>
</html>
