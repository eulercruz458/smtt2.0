<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Perícia - Deficiência Física</title>
  <script>
    const usuarioLogado = "usuario"; // mude para "solange" para acesso administrativo
    let vagasPreenchidas = {}; // Vagas preenchidas, será carregado do localStorage

    // Função para salvar vagas preenchidas no localStorage
    function salvarVagasPreenchidas() {
      localStorage.setItem("vagasPreenchidas", JSON.stringify(vagasPreenchidas));
    }

    // Função para carregar vagas preenchidas do localStorage
    function carregarVagasPreenchidas() {
      const dados = localStorage.getItem("vagasPreenchidas");
      if (dados) {
        vagasPreenchidas = JSON.parse(dados);
      }
    }

    function agendarPericia(nome, data, hora, turno, index) {
      const vagaId = `${turno}-${index}`;

      if (vagasPreenchidas[vagaId]) {
        alert(`Esta vaga já foi preenchida por ${vagasPreenchidas[vagaId].nome}.`);
        return;
      }

      const confirmacao = confirm(`Deseja agendar a perícia de ${nome} para o dia ${data} às ${hora}?`);
      if (confirmacao) {
        vagasPreenchidas[vagaId] = { nome, data, hora };
        salvarVagasPreenchidas();

        const botao = document.getElementById(`btn-${vagaId}`);
        botao.classList.remove("bg-green-500", "hover:bg-green-600");
        botao.classList.add("bg-red-500", "hover:bg-red-600");
        botao.innerText = nome;
        // Salva informações completas no localStorage
    localStorage.setItem("periciaAgendada", "true");
    localStorage.setItem("nomeAgendamento", nome);
    localStorage.setItem("dataAgendamento", data);
    localStorage.setItem("horaAgendamento", hora);

    // Log de depuração
    console.log("Perícia agendada com sucesso:");
    console.log("Nome:", nome);
    console.log("Data:", data);
    console.log("Hora:", hora);
    console.log("Turno:", turno);
    console.log("Vaga ID:", vagaId);

        alert("Perícia agendada com sucesso!");
      }
    }

    function definirDatasAdmin() {
      if (usuarioLogado !== "solange") return;
      const novaData = prompt("Digite a data (formato: dd/mm):");
      if (novaData) {
        document.querySelectorAll(".data-vaga").forEach(el => el.innerText = novaData);
      }
    }

    function gerarVagas(turnoIndex, hora, corClasse, turnoLabel) {
      let html = '';
      for (let i = 1; i <= 23; i++) {
        const vagaId = `${turnoLabel}-${i}`;
        const ocupada = vagasPreenchidas[vagaId];
        const textoBotao = ocupada ? ocupada.nome : `Vaga ${i}`;
        const cor = ocupada ? "bg-red-500 hover:bg-red-600" : corClasse;

        html += `  
          <button id="btn-${vagaId}"
            class="${cor} text-white py-1 rounded hover:opacity-90"
            onclick="coletarNomeEAgendar(document.querySelectorAll('.data-vaga')[${turnoIndex}].innerText, '${hora}', '${turnoLabel}', ${i})"
          >
            ${textoBotao}
          </button>
        `;
      }
      return html;
    }

    function coletarNomeEAgendar(data, hora, turno, index) {
      const nome = getNomeRequerente();

      if (!nome) {
        alert("Nome não encontrado no localStorage. Por favor, registre seu nome.");
        return;
      }

      agendarPericia(nome, data, hora, turno, index);
    }

    function getNomeRequerente() {
      return localStorage.getItem('nomeAgendamento') || null;
    }

    function verificarAgendamento() {
      const periciaAgendada = localStorage.getItem("periciaAgendada");
      if (!periciaAgendada) {
        alert("Você precisa agendar a perícia antes de voltar ao formulário.");
        return false;
      }
      return true;
    }

    // Ao carregar a página
    document.addEventListener("DOMContentLoaded", function () {
      carregarVagasPreenchidas();
      document.getElementById("vagas-manha").innerHTML = gerarVagas(0, "07:00", "bg-green-500 hover:bg-green-600", "manha");
      document.getElementById("vagas-tarde").innerHTML = gerarVagas(1, "13:00", "bg-green-500 hover:bg-green-600", "tarde");
    });
  </script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold text-center mb-4">Agendamento - Deficiência Física</h1>

    <div class="mb-4 text-center">
      <button 
        onclick="definirDatasAdmin()"
        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded"
      >
        Definir datas (somente Solange)
      </button>
    </div>

    <div class="mb-4 text-center">
      <button 
        onclick="if (verificarAgendamento()) { window.history.go(-2); }"
        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded"
      >
        Voltar para o Formulário
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Turno da Manhã - 07:00</h2>
        <p>Data: <span class="data-vaga">__/__</span></p>
        <div class="grid grid-cols-4 gap-2 mt-4" id="vagas-manha"></div>
      </div>

      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Turno da Tarde - 13:00</h2>
        <p>Data: <span class="data-vaga">__/__</span></p>
        <div class="grid grid-cols-4 gap-2 mt-4" id="vagas-tarde"></div>
      </div>
    </div>
  </div>
</body>
</html>
